<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fixeve タイマー</title>
<style>
  body {
    font-family: "Hiragino Kaku Gothic ProN", sans-serif;
    background-color: #eef6ff;
    text-align: center;
    margin: 0;
    padding: 30px;
  }
  h1 { font-size: 26px; }
  .time { font-size: 48px; margin: 20px 0; }
  button {
    margin: 8px;
    padding: 12px 25px;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    color: #fff;
  }
  .start { background-color: #007bff; }
  .pause { background-color: #888; }
  .end { background-color: #d9534f; }
  .select-btn { background-color: #28a745; }
  #total { margin-top: 20px; font-size: 18px; }
  a { display: block; margin-top: 25px; color: #007bff; font-weight: bold; text-decoration: none; }
</style>
</head>
<body>
<h1>Fixeve タイマー</h1>

<div>
  <button class="select-btn" onclick="selectMode('countup')">カウントアップ</button>
  <button class="select-btn" onclick="selectMode('pomodoro25')">25分/5分</button>
  <button class="select-btn" onclick="selectMode('pomodoro50')">50分/10分</button>
</div>

<div class="time" id="display">00:00</div>
<div id="statusText"></div>

<div>
  <button class="start" onclick="startTimer()">開始</button>
  <button class="pause" onclick="pauseTimer()">中断</button>
  <button class="end" onclick="endTimer()">終了</button>
</div>

<p id="total">今日の合計時間: 0時間0分</p>
<a href="https://fixeve.github.io/fixeve-home/">ホームに戻る</a>

<script>
let timer = null, elapsed = 0, isRunning = false, mode = "countup";
let studyRecords = JSON.parse(localStorage.getItem("studyRecords") || "{}");
let focusTime = 25*60, breakTime = 5*60, longBreak = 15*60;
let setCount = 0, flashing = false;

function selectMode(m){
  recordTime(); // ← 変更時に現在の時間を保存
  mode = m; elapsed = 0; setCount = 0; updateDisplay();
  document.body.style.backgroundColor = "#eef6ff";
}

function startTimer(){
  if (isRunning) return;
  isRunning = true;
  const start = Date.now() - elapsed*1000;
  timer = setInterval(()=>{
    elapsed = Math.floor((Date.now() - start)/1000);
    updateDisplay();
    if (mode !== "countup") checkPomodoro();
  }, 1000);
}

function pauseTimer(){
  if (!isRunning) return;
  clearInterval(timer);
  isRunning = false;
  recordTime();
  updateTotal();
}

function endTimer(){
  if (isRunning) pauseTimer();
  recordTime();
  elapsed = 0;
  updateDisplay();
  updateTotal();
  location.href = "https://fixeve.github.io/fixeve-home/";
}

function updateDisplay(){
  const m = String(Math.floor(elapsed/60)).padStart(2,"0");
  const s = String(elapsed%60).padStart(2,"0");
  document.getElementById("display").textContent = `${m}:${s}`;
}

function recordTime(){
  if (elapsed === 0) return;
  const dateKey = new Date().toLocaleDateString('sv-SE');
  studyRecords[dateKey] = (studyRecords[dateKey] || 0) + elapsed;
  localStorage.setItem("studyRecords", JSON.stringify(studyRecords));
  elapsed = 0;
}

function updateTotal(){
  const dateKey = new Date().toLocaleDateString('sv-SE');
  const total = studyRecords[dateKey] || 0;
  const h = Math.floor(total/3600);
  const m = Math.floor((total%3600)/60);
  document.getElementById("total").textContent = `今日の合計時間: ${h}時間${m}分`;
}

function checkPomodoro(){
  let cycle = mode==="pomodoro25" ? {focus:25*60, short:5*60, long:15*60}
             : {focus:50*60, short:10*60, long:30*60};
  const total = cycle.focus + cycle.short;
  if (elapsed >= cycle.focus) startFlashing();
}

function startFlashing(){
  flashing = true;
  clearInterval(timer); isRunning = false;
  let colors = ["#9f00ff","#000000","#baff00","#000000"];
  let i = 0;
  let flashInterval = setInterval(()=>{
    if(!flashing){
      clearInterval(flashInterval);
      document.body.style.backgroundColor="#eef6ff";
      return;
    }
    document.body.style.backgroundColor = colors[i%colors.length];
    i++;
  },150);
  document.body.addEventListener("click", ()=>{
    flashing=false; elapsed=0; setCount++; startTimer();
  },{once:true});
}

updateTotal();
</script>
</body>
</html>
